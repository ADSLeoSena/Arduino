
#include <U8glib.h>
#include <Ultrasonic.h>

Ultrasonic sensor (2,3); //2 trigger ,3 echo
U8GLIB_SSD1306_128X64_2X tela(U8G_I2C_OPT_NONE);
float dist,nivel;
int samples[7],tc=0,percent=0,tempo=0;
//***************************************************************************************************************
void draw (){  
            //conversão da variavel do tipo INTEIRO em string
           String A = String(percent); //String " nome " = String( variável a converter );
           const char* B = (const char*) A.c_str(); //  ponteiro para um const char com o valor resultante da conversão
           
           //conversão da variavel do tipo FLOAT em string
           String C = String(tc); 
           const char* D = (const char*) C.c_str();
           
           tela.drawRFrame(0, 0, 50, 64, 1); // impressão da moldura 
               
           
          //bargraph
            if (nivel >= 0.076){
             tela.drawBox(3,56,44,5);//barra inferior (nivel baixo)
               percent= 10;}
                else percent=0;
                
                  if (nivel >= 0.152){
                    tela.drawBox(3,50,44,5);
                      percent= 20;
                      
                        if (nivel >= 0.228){
                            tela.drawBox(3,44,44,5);
                              percent= 30;
                              
                                if (nivel >=0.304){
                                   tela.drawBox(3,38,44,5);
                                     percent= 40;
                                     
                                      if (nivel >=0.38){
                                          tela.drawBox(3,32,44,5);
                                          percent= 50;
                                        
                                              if (nivel >=0.456){
                                                  tela.drawBox(3,26,44,5);
                                                  percent= 60;
                                                  
                                                      if (nivel >= 0.532){
                                                           tela.drawBox(3,20,44,5);
                                                           percent= 70;
                                                          
                                                              if (nivel >= 0.608){
                                                                     tela.drawBox(3,14,44,5);
                                                                     percent= 80;
                                                                    
                                                                          if (nivel >=0.684){
                                                                               tela.drawBox(3,8,44,5);
                                                                               percent= 90;
                                                                               
                                                                                  if (nivel >= 0.76 && nivel <= 0.98){
                                                                                     tela.drawBox(3,2,44,5);
                                                                                     percent= 100;}}}}}}}}}//barra superior ( nivel alto )

           tela.drawStr(54,11,"NIVEL");
           tela.drawStr(54,46,"TEMP.");
           tela.drawStr(60,26,B);//impressão da variável distância convertida em texto
           tela.drawStr(60,60,D);//impressão da variável tempertura convertida em texto
           tela.drawCircle(85,52,2);
           tela.drawStr(90,60,"C");
           tela.drawStr(90,26,"%");
           
           }
           //FIM DA ROTINA DE IMPRESSÃO PELO DISPLAY
     //***************************************************************************************************************************************      
void setup(void) {
           tela.setFont(u8g_font_8x13B);
           Serial.begin(9600);
                 }
   //*****************************************************************************************************************************************
void loop(void) {

    //INICIO DA ROTINA DO DISPLAY
    
         tela.firstPage();
      
      do {
            draw();//FUNÇÃO QUE IMPRIME AS INFORMAÇÕES NO DISPLAY
           }
      while (tela.nextPage());
      delay(30);
      
   // FINAL DA ROTINA DO DISPLAY

   //LEITURA DO SENSOR ULTRASSONICO
      long med = sensor.timing(); // variavel crua do sensor
    dist = sensor.convert(med,Ultrasonic::CM)/100;//dist recebe o valor da conversão da variavel med em cm
    //********calculo do  nível***********
      nivel= 0.98 - dist;
      //Serial.println(nivel*10);
      
  //*********************************************************
    // LEITURA DA TEMPERATURA
             for ( int i=0; i<=15; i++){
               
             samples[i] = (4.7 * analogRead(0)* 100 )/1024;
              tc = tc+ samples[i];
              delay(12);
                 }
            tc = tc/16;
            delay(100);
            
     //*****************************************************      
     
 //********************************************************
}
